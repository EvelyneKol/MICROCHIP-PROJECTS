#include <avr/io.h>
#include <util/delay.h>
#include <avr/interrupt.h>
#define T2 10
#define T3 5
int disable_button = 0;
int x=0; //logic flag
void init_TCA0(void);

void init_TCA0(){//Timer for counting T2
	/* enable split mode */
	TCA0.SPLIT.CTRLD = TCA_SPLIT_SPLITM_bm;
	TCA0.SPLIT.LCNT = 0;
	TCA0.SPLIT.HCNT = 0;
	TCA0.SPLIT.CTRLB = TCA_SPLIT_HCMP0EN_bm | TCA_SPLIT_LCMP0EN_bm;
	TCA0.SPLIT.LCMP0 = T2;
	TCA0.SPLIT.HCMP0 = T3;
	TCA0.SPLIT.CTRLA = TCA_SPLIT_CLKSEL_DIV16_gc | TCA_SPLIT_ENABLE_bm;
	TCA0.SPLIT.INTCTRL = 0b00000001| 0b00000010 ;
}


int main() {
	//Begin with the car led ON.
	PORTD.DIR |= PIN0_bm|PIN1_bm|PIN2_bm;
	PORTD.OUTCLR = PIN2_bm;
	PORTD.OUT |= PIN0_bm|PIN1_bm;
	init_TCA0();//initialize train timer.
	PORTF.PIN5CTRL |= PORT_PULLUPEN_bm | PORT_ISC_BOTHEDGES_gc;
	sei();
	while (x==0) {
		;
	}
	cli();
}

ISR(TCA0_LUNF_vect){
	TCA0.SPLIT.INTFLAGS=0b00000001;
	PORTD.OUTCLR = PIN0_bm;
	PORTD.OUT |= PIN2_bm;
	disable_button = 1;
}

ISR(TCA0_HUNF_vect){
	TCA0.SPLIT.INTFLAGS=0b00000010;
	PORTD.OUTCLR = PIN2_bm;
	PORTD.OUT |= PIN1_bm;
	disable_button = 0;
}

ISR(PORTF_PORT_vect){//Interrupt for pressing button.
	int y = PORTF.INTFLAGS;
	PORTF.INTFLAGS=y;
	//The button has no functionality when a train is passing
	//and when it has been pressed T3 before;
	if(disable_button == 1)
	;
	//The button has been pressed and the pedestrian led must be turned ON.
	else{
		init_TCA0();
		PORTD.OUTCLR = PIN0_bm;
		PORTD.OUT |= PIN2_bm;
	}
}
